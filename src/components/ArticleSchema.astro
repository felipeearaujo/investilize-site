---
import type { ImageMetadata } from 'astro:assets';

export interface Props {
  title: string;
  description: string;
  // MUDANÇA 1: O '?' torna a data opcional
  publishDate?: Date;
  imagePath?: ImageMetadata; 
}

const { title, description, publishDate, imagePath } = Astro.props;

// Lógica de segurança para a imagem (mantivemos a correção anterior)
let imageUrl = undefined;
if (imagePath && imagePath.src) {
    try {
        imageUrl = new URL(imagePath.src, Astro.site).href;
    } catch (e) {
        imageUrl = imagePath.src;
    }
}

const canonicalURL = Astro.url.href;

// MUDANÇA 2: Verificamos se existe data antes de formatar
// Se não tiver data, usamos a data de hoje como fallback ou deixamos undefined
const dateString = publishDate ? publishDate.toISOString() : new Date().toISOString();

const schema = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": canonicalURL
  },
  "headline": title,
  "description": description,
  "image": imageUrl || "https://investilize.com.br/social-share-padrao.jpg", 
  "author": {
    "@type": "Organization",
    "name": "Investilize",
    "url": Astro.site ? new URL('/', Astro.site).href : "https://investilize.com.br"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Investilize",
    "logo": {
      "@type": "ImageObject",
      "url": Astro.site ? new URL('/logo.png', Astro.site).href : "https://investilize.com.br/logo.png"
    }
  },
  // Aqui usamos a variável segura que criamos acima
  "datePublished": dateString
};
---

<script type="application/ld+json" is:inline set:html={JSON.stringify(schema)} />