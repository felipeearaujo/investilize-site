---
// src/components/ferramentas/CalculadoraJuros.astro
// NÃO IMPORTAMOS LAYOUT, HEADER OU FOOTER AQUI.
// Este arquivo deve conter APENAS a calculadora.
---

<div class="tool-page">
    <div class="calculator-container">
        <p class="subtitle">Preencha os dados abaixo para simular:</p>
        
        <div class="grid-inputs">
            <div class="input-group">
                <label for="capital">Capital Inicial (R$):</label>
                <input type="number" id="capital" placeholder="Ex: 1000">
            </div>

            <div class="input-group">
                <label for="aporte">Aporte Mensal (R$):</label>
                <input type="number" id="aporte" placeholder="Ex: 300">
            </div>
            
            <div class="input-group">
                <label for="taxa">Taxa Mensal (%):</label>
                <input type="number" id="taxa" placeholder="Ex: 0.8" step="0.01">
                <small style="color: #666; font-size: 0.8em;">Ex: CDI hoje é ~0.85% ao mês</small>
            </div>

            <div class="input-group">
                <label for="tempo">Período (meses):</label>
                <input type="number" id="tempo" placeholder="Ex: 24">
            </div>
        </div>
        
        <button id="calculate-btn">Calcular e Gerar Gráfico</button>
        
        <div id="result-container"></div>

        <div class="chart-container">
            <canvas id="evolutionChart"></canvas>
        </div>
    </div>
</div>

<style>
    /* Estilos Locais da Calculadora */
    .tool-page { width: 100%; font-family: sans-serif; }
    .subtitle { text-align: center; margin-bottom: 25px; color: #666; }

    .calculator-container {
        background-color: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.08);
        border: 1px solid #f0f0f0;
        margin-top: 0;
    }
    .grid-inputs {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }
    @media (max-width: 600px) { .grid-inputs { grid-template-columns: 1fr; } }
    
    .input-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
    .input-group input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; }
    
    button { 
        width: 100%; padding: 15px; background-color: #2563eb; color: white; 
        border: none; border-radius: 8px; font-size: 1.1rem; font-weight: bold; cursor: pointer; 
        transition: background 0.2s;
    }
    button:hover { background-color: #1d4ed8; }

    #result-container { margin-top: 25px; padding: 15px; background: #f8fafc; border-radius: 8px; }
    .chart-container { margin-top: 40px; height: 350px; position: relative; }
</style>

<script>
    import Chart from 'chart.js/auto';

    function initCalculator() {
        const capitalInput = document.getElementById('capital') as HTMLInputElement;
        const aporteInput = document.getElementById('aporte') as HTMLInputElement;
        const taxaInput = document.getElementById('taxa') as HTMLInputElement;
        const tempoInput = document.getElementById('tempo') as HTMLInputElement;
        const calculateBtn = document.getElementById('calculate-btn');
        const resultContainer = document.getElementById('result-container');
        const chartCanvas = document.getElementById('evolutionChart') as HTMLCanvasElement;

        // Se não encontrar os elementos, sai da função (evita erros em outras páginas)
        if (!calculateBtn || !chartCanvas) return;

        let evolutionChart: Chart | null = null;

        calculateBtn.addEventListener('click', () => {
            const capitalInicial = parseFloat(capitalInput.value);
            const aporteMensal = parseFloat(aporteInput.value) || 0;
            const taxaJurosMensal = parseFloat(taxaInput.value);
            const tempoMeses = parseInt(tempoInput.value);

            if (isNaN(capitalInicial) || isNaN(taxaJurosMensal) || isNaN(tempoMeses)) {
                if(resultContainer) resultContainer.innerHTML = '<p style="color: red;">Preencha todos os campos obrigatórios.</p>';
                return;
            }

            const taxaDecimal = taxaJurosMensal / 100;
            const labels = ['Início'];
            const dataCapitalTotal = [capitalInicial];
            const dataMontanteTotal = [capitalInicial];
            
            let montanteAcumulado = capitalInicial;
            let capitalInvestido = capitalInicial;

            for (let mes = 1; mes <= tempoMeses; mes++) {
                montanteAcumulado += aporteMensal;
                montanteAcumulado *= (1 + taxaDecimal);
                capitalInvestido += aporteMensal;
                
                labels.push(`Mês ${mes}`);
                dataMontanteTotal.push(montanteAcumulado);
                dataCapitalTotal.push(capitalInvestido);
            }

            const montanteFinal = montanteAcumulado;
            const totalJuros = montanteFinal - capitalInvestido;
            const formatoMoeda = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });

            if(resultContainer) {
                resultContainer.innerHTML = `
                    <div style="display: grid; gap: 8px;">
                        <div style="font-size: 1.2rem; font-weight: bold;">Montante Final: <span style="color: #059669;">${formatoMoeda.format(montanteFinal)}</span></div>
                        <div style="color: #666;">Total Investido: ${formatoMoeda.format(capitalInvestido)}</div>
                        <div style="color: #666;">Total em Juros: <span style="color: #2563eb;">${formatoMoeda.format(totalJuros)}</span></div>
                    </div>
                `;
            }

            if (evolutionChart) evolutionChart.destroy();
            
            evolutionChart = new Chart(chartCanvas, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Total Acumulado',
                            data: dataMontanteTotal,
                            borderColor: '#2563eb',
                            backgroundColor: 'rgba(37, 99, 235, 0.1)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Dinheiro do Bolso',
                            data: dataCapitalTotal,
                            borderColor: '#94a3b8',
                            borderDash: [5, 5],
                            fill: false,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    scales: { y: { ticks: { callback: (v) => formatoMoeda.format(Number(v)) } } }
                }
            });
        });
    }

    // Inicialização segura para Astro (View Transitions ou normal)
    document.addEventListener('astro:page-load', initCalculator);
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initCalculator);
    } else {
        initCalculator();
    }
</script>