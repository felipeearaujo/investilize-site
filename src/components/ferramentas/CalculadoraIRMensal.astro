---
// Importa os dados sincronizados pelo seu script Python
import indicadores from '../../data/bacen.json';
const selicAtual = indicadores?.selic || "11.25";
---

<div class="tool-page">
    <div class="calculator-container">
        <p class="subtitle">Simule seu imposto mensal e veja o custo do atraso:</p>
        
        <div class="grid-inputs">
            <div class="input-group">
                <label for="renda">Rendimento Bruto (R$):</label>
                <input type="number" id="renda" placeholder="Ex: 5000">
            </div>

            <div class="input-group">
                <label for="dependentes">Nº de Dependentes:</label>
                <input type="number" id="dependentes" value="0">
            </div>
            
            <div class="input-group">
                <label for="deducoes">Outras Deduções (R$):</label>
                <input type="number" id="deducoes" placeholder="Ex: INSS, Pensão" value="0">
            </div>

            <div class="input-group">
                <label>Tabela Referência:</label>
                <input type="text" value="Ano Calendário 2025/2026" disabled class="input-disabled">
            </div>
        </div>
        
        <button id="calculate-ir-btn">Calcular Imposto e Multas</button>
        
        <div id="ir-result-container"></div>

        <div id="penalty-alert" class="penalty-card" style="display: none;">
            <div class="penalty-header">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                <span>Atenção: Custo do Atraso (60 dias)</span>
            </div>
            <div class="penalty-body">
                <p>O valor total a pagar pode subir para:</p>
                <div id="penalty-total" class="penalty-value">R$ 0,00</div>
                <ul class="penalty-details">
                    <li>Multa de Mora (20%): <span id="penalty-multa">R$ 0,00</span></li>
                    <li>Juros (Selic + 1%): <span id="penalty-juros">R$ 0,00</span></li>
                </ul>
                <small>*Simulação baseada na Selic oficial de {selicAtual}% ao ano.</small>
            </div>
        </div>

        <div class="chart-container">
            <canvas id="irTaxChart"></canvas>
        </div>
    </div>
</div>

<style>
    .tool-page { width: 100%; font-family: sans-serif; }
    .subtitle { text-align: center; margin-bottom: 25px; color: #666; }

    .calculator-container {
        background-color: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.08);
        border: 1px solid #f0f0f0;
    }
    .grid-inputs {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }
    @media (max-width: 600px) { .grid-inputs { grid-template-columns: 1fr; } }
    
    .input-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
    .input-group input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; }
    .input-disabled { background: #f1f5f9; cursor: not-allowed; color: #64748b; }
    
    button { 
        width: 100%; padding: 15px; background-color: #f97316; color: white; 
        border: none; border-radius: 8px; font-size: 1.1rem; font-weight: bold; cursor: pointer; 
        transition: background 0.2s;
    }
    button:hover { background-color: #ea580c; }

    #ir-result-container { margin-top: 25px; padding: 15px; background: #f8fafc; border-radius: 8px; border-left: 4px solid #2563eb; }
    .res-title { font-size: 1.1rem; font-weight: bold; color: #1e293b; margin-bottom: 10px; }
    .res-val { color: #ea580c; font-size: 1.4rem; font-weight: 800; }

    /* Estilos do Alerta de Multa */
    .penalty-card {
        margin-top: 25px;
        background: #fff1f2;
        border: 1px solid #fecaca;
        border-radius: 12px;
        overflow: hidden;
    }
    .penalty-header {
        background: #e11d48;
        color: white;
        padding: 10px 16px;
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: bold;
    }
    .penalty-body { padding: 20px; color: #9f1239; }
    .penalty-value { font-size: 2rem; font-weight: 900; margin: 10px 0; }
    .penalty-details { list-style: none; padding: 0; font-size: 0.9rem; margin: 15px 0; border-top: 1px solid #fecaca; padding-top: 10px; }
    .penalty-details li { display: flex; justify-content: space-between; margin-bottom: 5px; }
    
    .chart-container { margin-top: 40px; height: 320px; position: relative; }
</style>

<script is:inline define:vars={{ selicAtual }}>
    function initIR() {
        const calculateBtn = document.getElementById('calculate-ir-btn');
        const chartCanvas = document.getElementById('irTaxChart');
        if (!calculateBtn || !chartCanvas) return;

        let irChart = null;
        const format = (v) => v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

        calculateBtn.addEventListener('click', () => {
            const rendaBruta = parseFloat(document.getElementById('renda').value) || 0;
            const numDep = parseInt(document.getElementById('dependentes').value) || 0;
            const outrasDeducoes = parseFloat(document.getElementById('deducoes').value) || 0;
            const selic = parseFloat(selicAtual);

            if (rendaBruta <= 0) return;

            // 1. Cálculo IR
            const base = Math.max(0, rendaBruta - (numDep * 189.59) - outrasDeducoes);
            const tabela = [
                { limite: 2259.20, aliq: 0, ded: 0 },
                { limite: 2826.65, aliq: 0.075, ded: 169.44 },
                { limite: 3751.05, aliq: 0.15, ded: 381.44 },
                { limite: 4664.68, aliq: 0.225, ded: 662.77 },
                { limite: Infinity, aliq: 0.275, ded: 896.00 }
            ];
            const faixa = tabela.find(f => base <= f.limite) || tabela[tabela.length - 1];
            const imposto = Math.max(0, (base * faixa.aliq) - faixa.ded);
            const rendaLiquida = rendaBruta - imposto;
            const aliqEfetiva = ((imposto / rendaBruta) * 100).toFixed(2);

            // 2. Cálculo Multa (60 dias de atraso simulados)
            const multaMora = imposto * 0.20; 
            const jurosMora = imposto * ((selic / 12 / 100) * 2 + 0.01);
            const totalAtraso = imposto + multaMora + jurosMora;

            // 3. Renderizar Resultados
            document.getElementById('ir-result-container').innerHTML = `
                <div class="res-title">Resultado do Cálculo:</div>
                <div style="display: grid; gap: 5px;">
                    <div>Imposto Mensal: <span class="res-val">${format(imposto)}</span></div>
                    <div>Alíquota Efetiva: <strong>${aliqEfetiva}%</strong></div>
                    <div style="color: #059669;">Renda Líquida: <strong>${format(rendaLiquida)}</strong></div>
                </div>
            `;

            const penaltyAlert = document.getElementById('penalty-alert');
            if (imposto > 0) {
                penaltyAlert.style.display = 'block';
                document.getElementById('penalty-total').innerText = format(totalAtraso);
                document.getElementById('penalty-multa').innerText = format(multaMora);
                document.getElementById('penalty-juros').innerText = format(jurosMora);
            } else {
                penaltyAlert.style.display = 'none';
            }

            // 4. Gráfico
            if (irChart) irChart.destroy();
            irChart = new Chart(chartCanvas, {
                type: 'doughnut',
                data: {
                    labels: ['Renda Líquida', 'Imposto de Renda'],
                    datasets: [{
                        data: [rendaLiquida, imposto],
                        backgroundColor: ['#059669', '#ea580c'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } }
                }
            });
        });
    }

    document.addEventListener('astro:page-load', initIR);
    initIR();
</script>