---
// src/components/ferramentas/ConversorMoedas.astro
---

<div class="tool-page">
  <div class="calculator-container">
    <div class="header-icon">üí±</div>
    <h2>Conversor de Moedas</h2>
    <p class="subtitle">Cota√ß√µes comerciais atualizadas em tempo real</p>
    
    <div class="converter-body">
      <div class="currency-group">
        <label for="from_currency">De:</label>
        <select id="from_currency"></select>
        <input type="number" id="from_amount" value="1" placeholder="1.00" />
      </div>
      
      <button id="swap-btn" class="swap-icon-container" aria-label="Inverter moedas">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 21L3 16.5m0 0L7.5 12M3 16.5h13.5m0-13.5L21 7.5m0 0L16.5 12M21 7.5H7.5" />
        </svg>
      </button>

      <div class="currency-group">
        <label for="to_currency">Para:</label>
        <select id="to_currency"></select>
        <input type="number" id="to_amount" placeholder="Resultado" readonly />
      </div>
    </div>

    <div id="rate-info" class="rate-display">Carregando taxas...</div>
  </div>
</div>

<style>
  /* Padr√£o Investilize */
  .tool-page { width: 100%; font-family: sans-serif; }
  
  .calculator-container {
    background-color: white;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
    border: 1px solid #f0f0f0;
    width: 100%;
    max-width: 600px;
    text-align: center;
    margin: 0 auto;
    box-sizing: border-box;
  }

  .header-icon { font-size: 2rem; margin-bottom: 10px; }
  h2 { color: #1f2937; margin: 0; font-size: 1.8rem; }
  .subtitle { margin-top: 5px; margin-bottom: 30px; color: #6b7280; font-size: 0.95rem; }

  .converter-body {
    display: flex;
    align-items: flex-end; /* Alinha inputs e bot√£o pela base */
    justify-content: space-between;
    gap: 10px;
    margin-bottom: 20px;
  }

  .currency-group {
    display: flex;
    flex-direction: column;
    width: 42%;
    text-align: left;
  }

  label { font-size: 0.9rem; font-weight: 600; color: #374151; margin-bottom: 5px; }

  select, input {
    width: 100%;
    padding: 12px;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    font-size: 1rem;
    box-sizing: border-box;
    transition: border-color 0.2s;
    outline: none;
  }

  select { background-color: #f9fafb; cursor: pointer; }
  input { font-weight: 700; color: #111827; }
  
  select:focus, input:focus { border-color: #7c3aed; }

  /* Input de resultado readonly parece desabilitado mas leg√≠vel */
  input[readonly] { background-color: #f3f4f6; color: #4b5563; }

  /* Bot√£o de Inverter */
  .swap-icon-container {
    background: #f3f4f6;
    border: none;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #7c3aed;
    cursor: pointer;
    transition: all 0.2s;
    margin-bottom: 4px; /* Ajuste fino de alinhamento */
  }
  .swap-icon-container:hover { background: #7c3aed; color: white; transform: rotate(180deg); }
  .swap-icon-container svg { width: 20px; height: 20px; }

  /* Info da Taxa */
  .rate-display {
    margin-top: 20px;
    padding: 15px;
    background-color: #f0fdf4; /* Verde claro */
    color: #166534;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.95rem;
  }

  @media (max-width: 500px) {
    .converter-body { flex-direction: column; align-items: center; }
    .currency-group { width: 100%; }
    .swap-icon-container { margin: 10px 0; transform: rotate(90deg); }
    .swap-icon-container:hover { transform: rotate(270deg); }
  }
</style>

<script>
  function initConverter() {
    const fromSelect = document.getElementById('from_currency');
    const toSelect = document.getElementById('to_currency');
    const fromInput = document.getElementById('from_amount');
    const toInput = document.getElementById('to_amount');
    const rateInfo = document.getElementById('rate-info');
    const swapBtn = document.getElementById('swap-btn');

    if (!fromSelect || !toSelect || !fromInput || !toInput || !rateInfo) return;

    const API_URL = 'https://api.frankfurter.app';

    // Lista de moedas principais para priorizar no topo
    const priorityCurrencies = ['BRL', 'USD', 'EUR', 'GBP', 'CAD', 'AUD'];

    async function populateCurrencies() {
      try {
        const res = await fetch(`${API_URL}/currencies`);
        const data = await res.json();
        
        // Fun√ß√£o auxiliar para criar op√ß√µes
        const createOption = (code, name) => {
           const opt = document.createElement('option');
           opt.value = code;
           opt.textContent = `${code} - ${name}`;
           return opt;
        };

        // Limpa selects
        fromSelect.innerHTML = '';
        toSelect.innerHTML = '';

        // Adiciona Priorit√°rias Primeiro
        priorityCurrencies.forEach(code => {
          if (data[code]) {
            fromSelect.appendChild(createOption(code, data[code]));
            toSelect.appendChild(createOption(code, data[code]));
          }
        });

        // Separador visual
        const sep1 = document.createElement('option'); sep1.disabled = true; sep1.textContent = '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ';
        const sep2 = document.createElement('option'); sep2.disabled = true; sep2.textContent = '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ';
        fromSelect.appendChild(sep1);
        toSelect.appendChild(sep2);

        // Restante das moedas
        for (const code in data) {
           if (!priorityCurrencies.includes(code)) {
             fromSelect.appendChild(createOption(code, data[code]));
             toSelect.appendChild(createOption(code, data[code]));
           }
        }

        // Defaults: BRL -> USD √© mais comum para brasileiros verem a cota√ß√£o do d√≥lar
        // Mas a API frankfurter usa EUR como base interna. Vamos garantir que funcione.
        fromSelect.value = 'USD'; 
        toSelect.value = 'BRL'; 
        
        convert();
      } catch (err) {
        rateInfo.textContent = 'Erro ao carregar lista de moedas.';
      }
    }

    async function convert() {
      const from = (fromSelect as HTMLSelectElement).value;
      const to = (toSelect as HTMLSelectElement).value;
      const amount = parseFloat((fromInput as HTMLInputElement).value);

      if (isNaN(amount)) {
        rateInfo.textContent = 'Digite um valor v√°lido';
        return;
      }

      if (from === to) {
        (toInput as HTMLInputElement).value = amount.toFixed(2);
        rateInfo.textContent = `1 ${from} = 1 ${to}`;
        return;
      }

      rateInfo.textContent = 'Atualizando...';
      
      try {
        const res = await fetch(`${API_URL}/latest?amount=${amount}&from=${from}&to=${to}`);
        const data = await res.json();
        
        if (data.rates && data.rates[to]) {
           const finalVal = data.rates[to];
           (toInput as HTMLInputElement).value = finalVal.toFixed(2);
           
           // Pega a taxa unit√°ria para exibi√ß√£o
           const unitRate = finalVal / amount;
           rateInfo.textContent = `1 ${from} = ${unitRate.toFixed(4)} ${to}`;
        }
      } catch (err) {
        rateInfo.textContent = 'Erro na conex√£o.';
      }
    }

    // Eventos
    fromSelect.addEventListener('change', convert);
    toSelect.addEventListener('change', convert);
    fromInput.addEventListener('input', convert);
    
    // Bot√£o Inverter
    if (swapBtn) {
        swapBtn.addEventListener('click', () => {
            const temp = (fromSelect as HTMLSelectElement).value;
            (fromSelect as HTMLSelectElement).value = (toSelect as HTMLSelectElement).value;
            (toSelect as HTMLSelectElement).value = temp;
            convert();
        });
    }

    // Inicializa
    populateCurrencies();
  }

  document.addEventListener('astro:page-load', initConverter);
  if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initConverter);
  } else {
      initConverter();
  }
</script>